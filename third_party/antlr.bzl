# Rules for generating parsers using ANTLR4.
def _antlr_srcjar_impl(ctx):
    src_jar = ctx.outputs.src_jar
    option_file = ctx.actions.declare_file(src_jar.path + ".src")
    ctx.actions.write(output = option_file, content = "\n".join([src.path for src in ctx.files.srcs]))
    if ctx.attr.package != None:
        package_args = ["-package", ctx.attr.package]
    else:
        package_args = []  
    args = package_args + ["-o", src_jar.path, "@" + option_file.path]
    # Invoke our custom AntlrCompiler.
    ctx.actions.run(
        inputs = ctx.files.srcs + [option_file],
        outputs = [src_jar],
        mnemonic = "antlr",
        arguments = args,
        executable = ctx.executable._antlr,
    )
# Provides a srcjar with the sources generated by ANTLR. The rule should be used as part of the
# srcs in a java_library.
antlr_sources = rule(
    attrs = {
        "srcs": attr.label_list(
            allow_empty = False,
            allow_files = True,
        ),
        "package": attr.string(),
        "_antlr": attr.label(
            executable = True,
            cfg = "host",
            default = Label("//third_party:antlr"),
            allow_files = True,
        ),
    },
    outputs = {
        "src_jar": "%{name}.srcjar",
    },
    implementation = _antlr_srcjar_impl,
)
